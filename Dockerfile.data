# Sapheneia Finance Data Service Dockerfile
# Go service for fetching Yahoo Finance data and writing to InfluxDB
#
# Examples:
#   docker build -f Dockerfile.data -t sapheneia-data .

# Build stage
FROM --platform=linux/arm64 golang:1.25-alpine AS builder

WORKDIR /build

# Install build dependencies
RUN apk add --no-cache git ca-certificates

# Copy go module files
COPY data/go.mod data/go.sum ./
RUN go mod download

# Copy source code
COPY data/ ./

# Build the binary
RUN CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-w -s" -o finance-data main.go

# Runtime stage
FROM --platform=linux/arm64 alpine:latest

# Install ca-certificates for HTTPS
RUN apk --no-cache add ca-certificates curl

WORKDIR /app

# Copy the binary from builder
COPY --from=builder /build/finance-data .

# Expose port 8000
EXPOSE 8000

# Health check
HEALTHCHECK --interval=10s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Run the binary
CMD ["./finance-data"]
