services:
  # FastAPI Backend - Forecast API (serves all models)
  # NOTE: Uses module-level state - MUST run with single worker (UVICORN_WORKERS=1)
  # For parallel processing, implement Redis state backend (see REMEDIATION_PLAN.md Phase 4)
  forecast:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: all
        MODEL_PORT: 8000
    container_name: sapheneia-forecast
    ports:
      - "${API_PORT:-8000}:8000"
    env_file:
      - .env
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=all
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./data:/app/data
      - ./logs:/app/logs
      - forecast_models_timesfm20:/app/forecast/models/timesfm20/local
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # Extended for model loading time

  # Amazon Chronos Models - Separate containers for each variant
  # Each container mounts the pre-downloaded models cache from Aleutian

  forecast-chronos-t5-tiny:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: chronos
        MODEL_PORT: 8000
    container_name: forecast-chronos-t5-tiny
    ports:
      - "8100:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=chronos
      - MODEL_VARIANT=amazon/chronos-t5-tiny
      - HF_HOME=/models_cache
      - DEVICE=cpu
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./logs:/app/logs
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  forecast-chronos-t5-mini:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: chronos
        MODEL_PORT: 8000
    container_name: forecast-chronos-t5-mini
    ports:
      - "8101:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=chronos
      - MODEL_VARIANT=amazon/chronos-t5-mini
      - HF_HOME=/models_cache
      - DEVICE=cpu
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./logs:/app/logs
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  forecast-chronos-t5-small:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: chronos
        MODEL_PORT: 8000
    container_name: forecast-chronos-t5-small
    ports:
      - "8102:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=chronos
      - MODEL_VARIANT=amazon/chronos-t5-small
      - HF_HOME=/models_cache
      - DEVICE=cpu
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./logs:/app/logs
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  forecast-chronos-t5-base:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: chronos
        MODEL_PORT: 8000
    container_name: forecast-chronos-t5-base
    ports:
      - "8103:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=chronos
      - MODEL_VARIANT=amazon/chronos-t5-base
      - HF_HOME=/models_cache
      - DEVICE=cpu
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./logs:/app/logs
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  forecast-chronos-t5-large:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: chronos
        MODEL_PORT: 8000
    container_name: forecast-chronos-t5-large
    ports:
      - "8104:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=chronos
      - MODEL_VARIANT=amazon/chronos-t5-large
      - HF_HOME=/models_cache
      - DEVICE=cpu
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./logs:/app/logs
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  forecast-chronos-bolt-mini:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: chronos
        MODEL_PORT: 8000
    container_name: forecast-chronos-bolt-mini
    ports:
      - "8105:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=chronos
      - MODEL_VARIANT=amazon/chronos-bolt-mini
      - HF_HOME=/models_cache
      - DEVICE=cpu
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./logs:/app/logs
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  forecast-chronos-bolt-small:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: chronos
        MODEL_PORT: 8000
    container_name: forecast-chronos-bolt-small
    ports:
      - "8106:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=chronos
      - MODEL_VARIANT=amazon/chronos-bolt-small
      - HF_HOME=/models_cache
      - DEVICE=cpu
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./logs:/app/logs
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  forecast-chronos-bolt-base:
    build:
      context: .
      dockerfile: Dockerfile.forecast
      args:
        MODEL_NAME: chronos
        MODEL_PORT: 8000
    container_name: forecast-chronos-bolt-base
    ports:
      - "8107:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - MODEL_NAME=chronos
      - MODEL_VARIANT=amazon/chronos-bolt-base
      - HF_HOME=/models_cache
      - DEVICE=cpu
      - PYTHONPATH=/app
      - API_SECRET_KEY=default_trading_api_key_please_change
    volumes:
      - ./forecast:/app/forecast
      - ./logs:/app/logs
      - /Volumes/ai_models/aleutian_data/models_cache:/models_cache
    networks:
      - aleutian-network
    restart: "no"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Optional: Separate TimesFM-2.0 API Service (uncomment to run as separate service)
  # api-timesfm20:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.api
  #     args:
  #       MODEL_NAME: timesfm20
  #       MODEL_PORT: 8001
  #   container_name: sapheneia-api-timesfm20
  #   ports:
  #     - "${TIMESFM20_MODEL_PORT:-8001}:8001"
  #   env_file:
  #     - .env
  #   environment:
  #     - API_HOST=0.0.0.0
  #     - API_PORT=8001
  #     - MODEL_NAME=timesfm20
  #     - PYTHONPATH=/app
  #   volumes:
  #     - ./api:/app/api
  #     - ./data:/app/data
  #     - ./logs:/app/logs
  #     - api_models_timesfm20:/app/api/models/timesfm20/local
  #   networks:
  #     - aleutian-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 120s

  # Flask UI
  ui:
    build:
      context: .
      dockerfile: Dockerfile.ui
    container_name: sapheneia-ui
    ports:
      - "8080:8080"
    environment:
      - UI_API_BASE_URL=http://forecast:8000
      - UI_PORT=8080
      - PYTHONPATH=/app
    volumes:
      - ./ui:/app/ui
      - ./data:/app/data
      - ./logs:/app/logs
      - ui_results:/app/ui/results
    depends_on:
      forecast:
        condition: service_healthy
    networks:
      - aleutian-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Trading Strategies API
  trading:
    build:
      context: .
      dockerfile: Dockerfile.trading
    container_name: sapheneia-trading
    ports:
      - "${TRADING_API_PORT:-9000}:9000"
    env_file:
      - .env
    environment:
      - TRADING_API_KEY=${TRADING_API_KEY}
      - TRADING_API_HOST=0.0.0.0
      - TRADING_API_PORT=9000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TRADING_API_KEY=default_trading_api_key_please_change
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - PYTHONPATH=/app
    volumes:
      - ./trading:/app/trading
      - ./logs:/app/logs
    networks:
      - aleutian-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Finance Data Service (Yahoo Finance â†’ InfluxDB)
  data:
    build:
      context: .
      dockerfile: Dockerfile.data
    container_name: sapheneia-data
    ports:
      - "${DATA_API_PORT:-8001}:8000"
    environment:
      - INFLUXDB_URL=http://user-influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-your_super_secret_admin_token}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-aleutian-finance}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-financial-data}
    networks:
      - aleutian-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 10s

networks:
  aleutian-network:
    external: true
    name: aleutian-shared

volumes:
  forecast_models_timesfm20:
    driver: local
  ui_results:
    driver: local
